# Cross-Validationè¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

> [!IMPORTANT]
> ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯CVè¨­è¨ˆã®æ ¹æ‹ ã¨å®Ÿè£…æ–¹é‡ã‚’è¨˜è¼‰ã™ã‚‹ã€‚

---

## 1. ãƒ‡ãƒ¼ã‚¿æ¦‚è¦

### è¨“ç·´ãƒ‡ãƒ¼ã‚¿
| é …ç›® | å€¤ |
|------|-----|
| ã‚µãƒ³ãƒ—ãƒ«æ•° | 1,200 |
| ã‚«ãƒ†ã‚´ãƒª | A, B, C |
| ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒ | **å®Œå…¨å‡ç­‰** (400:400:400) |

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
| é …ç›® | å€¤ |
|------|-----|
| ã‚µãƒ³ãƒ—ãƒ«æ•° | 300 |
| ã‚«ãƒ†ã‚´ãƒªæƒ…å ± | **ãªã—ï¼ˆéå…¬é–‹ï¼‰** |

---

## 2. ã‚«ãƒ†ã‚´ãƒªç‰¹æ€§åˆ†æ

### 2.1 INPUTç”»åƒï¼ˆé€éå…‰ç”»åƒï¼‰

| ã‚«ãƒ†ã‚´ãƒª | å¹³å‡è¼åº¦ | ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ(std) | ç‰¹å¾´ |
|---------|---------|------------------|------|
| A | 78.91 Â± 8.05 | 80.48 Â± 9.38 | æ˜ã‚‹ãé«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ |
| B | 76.76 Â± 8.33 | 80.69 Â± 8.46 | Aã«é¡ä¼¼ |
| **C** | **66.46 Â± 7.50** | **70.15 Â± 8.31** | **æš—ãä½ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ** |

### 2.2 TARGETç”»åƒï¼ˆè›å…‰ç”»åƒï¼‰

| ã‚«ãƒ†ã‚´ãƒª | å¹³å‡è¼åº¦ | ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ(std) | ç‰¹å¾´ |
|---------|---------|------------------|------|
| **A** | 48.43 Â± 6.07 | **92.36 Â± 5.19** | **æœ€ã‚‚æ§‹é€ ãŒã¯ã£ãã‚Š** |
| B | 45.18 Â± 7.14 | 82.78 Â± 5.59 | ä¸­é–“çš„ |
| **C** | 46.23 Â± 10.28 | **66.71 Â± 13.95** | **ä½ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã€ã°ã‚‰ã¤ãå¤§** |

### 2.3 å¤‰æ›ã®è¤‡é›‘ã•ï¼ˆINPUTâ†’TARGETï¼‰

| ã‚«ãƒ†ã‚´ãƒª | è¼åº¦ã‚·ãƒ•ãƒˆ | ç¯„å›² | è§£é‡ˆ |
|---------|-----------|------|------|
| A | -30.48 Â± 12.88 | [-57, -2] | å®‰å®šã—ãŸå¤‰æ› |
| B | -31.59 Â± 14.10 | [-60, +9] | ã‚„ã‚„ä¸å®‰å®š |
| **C** | -20.24 Â± 14.57 | [-61, +5] | **å¤‰æ›ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¤šæ§˜** |

---

## 3. é›£æ˜“åº¦è©•ä¾¡

```
æ˜“ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ é›£
     A          B          C
```

| ã‚«ãƒ†ã‚´ãƒª | é›£æ˜“åº¦ | ç†ç”± |
|---------|--------|------|
| **A** | ğŸŸ¢ æ˜“ | é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã€å®‰å®šã—ãŸå¤‰æ›ãƒ‘ã‚¿ãƒ¼ãƒ³ |
| **B** | ğŸŸ¡ ä¸­ | ä¸­é–“çš„ãªç‰¹æ€§ |
| **C** | ğŸ”´ é›£ | ä½ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã€å¤‰æ›ã°ã‚‰ã¤ãå¤§ã€äºˆæ¸¬å›°é›£ |

> [!WARNING]
> Category C ã®æ€§èƒ½ãŒå…¨ä½“ã‚¹ã‚³ã‚¢ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚

---

## 4. CVæˆ¦ç•¥

### 4.1 æ¨å¥¨æ‰‹æ³•: Stratified K-Fold

```python
from sklearn.model_selection import StratifiedKFold

skf = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

for fold, (train_idx, val_idx) in enumerate(skf.split(df, df['category'])):
    train_df = df.iloc[train_idx]  # 960 samples
    val_df = df.iloc[val_idx]      # 240 samples
    # å„fold: A:320, B:320, C:320 (train) / A:80, B:80, C:80 (val)
```

### 4.2 ãªãœStratifiedã‹ï¼Ÿ

| æ‰‹æ³• | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|---------|-----------|
| Random Split | ã‚·ãƒ³ãƒ—ãƒ« | ã‚«ãƒ†ã‚´ãƒªåã‚Šã®ãƒªã‚¹ã‚¯ |
| **Stratified K-Fold** | **ã‚«ãƒ†ã‚´ãƒªæ¯”ç‡ç¶­æŒ** | ã‚„ã‚„è¤‡é›‘ |
| Group K-Fold | ã‚°ãƒ«ãƒ¼ãƒ—ãƒªãƒ¼ã‚¯é˜²æ­¢ | ã‚«ãƒ†ã‚´ãƒª = ã‚°ãƒ«ãƒ¼ãƒ—ã§ã¯ãªã„ |

### 4.3 Foldè¨­è¨ˆ

| Fold | Train | Validation |
|------|-------|------------|
| å„Foldå…±é€š | A:320 + B:320 + C:320 = 960 | A:80 + B:80 + C:80 = 240 |

---

## 5. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] `train_notebook.py` ã‚’ Stratified K-Fold ã«å¤‰æ›´ â†’ `train_kfold()` é–¢æ•°è¿½åŠ 
- [x] ã‚«ãƒ†ã‚´ãƒªåˆ¥SSIM/PSNRæ¸¬å®šã‚’è¿½åŠ  â†’ `validate_with_categories()` é–¢æ•°è¿½åŠ 
- [x] å„foldã®çµæœã‚’è¨˜éŒ²ãƒ»å¹³å‡åŒ– â†’ `cv_results.json` ã¨ã—ã¦å‡ºåŠ›
- [ ] Category C ã®æ€§èƒ½ã‚’é‡ç‚¹ç›£è¦– â†’ å®Ÿé¨“å®Ÿè¡Œå¾Œã«æ¤œè¨¼

---

## 6. è©•ä¾¡æŒ‡æ¨™ã®æ‹¡å¼µ

### å®Ÿè£…æ¸ˆã¿: ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹

```python
# kaggle/train_notebook.py ã® validate_with_categories() ã‚’å‚ç…§
# ä½¿ç”¨æ–¹æ³•:
#   N_FOLDS=5 python kaggle/train_notebook.py
#
# å‡ºåŠ›ä¾‹:
#   Val SSIM: 0.8650 (A:0.89, B:0.87, C:0.83)
#   Val PSNR: 28.50 (A:30.2, B:28.8, C:26.5)
```

---

## 7. å®Ÿé¨“å±¥æ­´

### 7.1 exp_007 v1: åŸºæœ¬5-Fold CV

**å®Ÿæ–½æ—¥**: 2026-01-07

| Metric | Mean | Std |
|--------|------|-----|
| **SSIM** | 0.8662 | Â±0.0183 |
| **PSNR** | 15.30 dB | Â±1.76 |

**ã‚«ãƒ†ã‚´ãƒªåˆ¥SSIM**:
| A | B | C |
|---|---|---|
| 0.9126 | 0.8778 | 0.8081 |

> [!CAUTION]
> Category C ã¯Aã‚ˆã‚Š**0.10ä½ã„** â†’ ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç¢ºå®š

---

### 7.2 exp_007 v2: Worst-Case CVè¿½åŠ 

**å®Ÿæ–½æ—¥**: 2026-01-07

**æ–°è¦KPI: Cã®ä¸‹ä½20% (ssim_C_worst20)**

| Metric | Value |
|--------|-------|
| ssim_C_worst20_mean | 0.7256 |
| **ssim_C_worst20_min** | **0.7047** |

**Foldåˆ¥ C worst20%**:
| Fold | C_worst20 |
|------|-----------|
| 1 | 0.7155 |
| 2 | 0.7124 |
| 3 | 0.7634 |
| **4** | **0.7047** â† æœ€æ‚ª |
| 5 | 0.7321 |

> [!WARNING]
> å¹³å‡SSIM 0.86 ã«å¯¾ã—ã¦ worst20% ã¯ **0.70** â†’ LBã§åˆºã•ã‚Œã‚‹å…¸å‹ãƒ‘ã‚¿ãƒ¼ãƒ³

---

### 7.3 exp_007 v3: C ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

**å®Ÿæ–½æ—¥**: 2026-01-08

**å¤‰æ›´å†…å®¹**:
- Cã‚’ `C_easy`, `C_medium`, `C_hard` ã«åˆ†å‰²ï¼ˆdark_ratioåŸºæº–ï¼‰
- K-Foldã‚’5ã‚°ãƒ«ãƒ¼ãƒ— (A, B, C_easy, C_medium, C_hard) ã§å±¤åŒ–

**çµæœ**: âš ï¸ **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ç™ºç”Ÿ**

| Metric | v2 | v3 | å¤‰åŒ– |
|--------|-----|-----|------|
| ssim_mean | 0.8628 | 0.8714 | +0.009 âœ… |
| ssim_std | 0.0227 | 0.0187 | -0.004 âœ… |
| **ssim_C_worst20_min** | 0.7047 | **0.6544** | **-0.050** ğŸ”´ |

**Foldåˆ¥ C_worst20 (v3)**:
| Fold | C_worst20 |
|------|-----------|
| **1** | **0.6544** â† å¤§å¹…æ‚ªåŒ– |
| 2 | 0.6730 |
| 3 | 0.7820 |
| 4 | 0.7472 |
| 5 | 0.7292 |

**åˆ†æ**:
- å¹³å‡SSIMã¯æ”¹å–„ã€stdã‚‚æ”¹å–„ â†’ è¡¨é¢ä¸Šã¯è‰¯ãè¦‹ãˆã‚‹
- **worst-caseã¯0.05æ‚ªåŒ–** â†’ C_hardãŒç‰¹å®šfoldã«é›†ä¸­ã—ãŸå¯èƒ½æ€§
- Fold 1ãŒç•°å¸¸ã«æ‚ªã„ â†’ ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ãŒæ„å›³é€šã‚Šã«æ©Ÿèƒ½ã—ã¦ã„ãªã„

> [!CAUTION]
> **æ•™è¨“**: å¹³å‡ãƒ»stdã®æ”¹å–„ã ã‘ã§ã¯åˆ¤æ–­ã§ããªã„ã€‚worst-caseã‚’å¸¸ã«ç›£è¦–ã™ã¹ãã€‚

---

### 7.4 exp_007 v4: Worst-Case Controlled CV

**å®Ÿæ–½æ—¥**: 2026-01-08

**è¨­è¨ˆå¤‰æ›´** (v3ã®å¤±æ•—ã‹ã‚‰å­¦ç¿’):

| å¤‰æ›´ç‚¹ | v3 | v4 |
|--------|-----|-----|
| ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚° | é›¢æ•£ (C_easy/medium/hard) | **é€£ç¶šå€¤ (dark_ratio)** |
| C_hard ã®æ‰±ã„ | å…¨foldã«åˆ†æ•£ | **60%ã‚’Trainå›ºå®š** |
| Worstè©•ä¾¡ | äº‹å¾ŒæŠ½å‡º | **worst_valå›ºå®š (top 20%)** |
| KPI | ssim_C_worst20_min | **ssim_worst_val_min** |

**å®Ÿè£…**:
```python
# ç’°å¢ƒå¤‰æ•°ã§åˆ‡ã‚Šæ›¿ãˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: worst_case)
CV_MODE=worst_case python kaggle/train_notebook.py

# æ—§ãƒ¢ãƒ¼ãƒ‰ (æ¯”è¼ƒç”¨)
CV_MODE=kfold python kaggle/train_notebook.py
```

**Splitæ§‹é€ **:
```
Total: 1200 samples
â”œâ”€â”€ worst_val (å›ºå®š): 80 samples (C dark_ratio top 20%)
â”œâ”€â”€ c_hard_train (å›ºå®š): 96 samples (C_hard 60%)
â””â”€â”€ trainable (K-Fold): 1024 samples
```

**çµæœ**: (å®Ÿè¡Œå¾Œã«è¨˜å…¥)

| Metric | v3 | v4 | å¤‰åŒ– |
|--------|-----|-----|------|
| ssim_mean | 0.8714 | TBD | |
| ssim_worst_val_min | 0.6544 | TBD | |

---

## 8. å­¦ã‚“ã æ•™è¨“

### 8.1 CVè¨­è¨ˆã®ç›²ç‚¹

| ç›²ç‚¹ | ç¾è±¡ | å¯¾ç­– |
|------|------|------|
| å¹³å‡ä¾å­˜ | å¹³å‡SSIMæ”¹å–„ã§ã‚‚worstãŒæ‚ªåŒ– | **ssim_C_worst20_minã‚’KPIã«** |
| å˜ç´”å±¤åŒ– | Stratifiedã§ã‚‚é‹ã‚²ãƒ¼ | Multi-seed CVã§æœ€æ‚ªfoldæ¤œè¨¼ |
| ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã®ç½  | Cåˆ†å‰²ã§worstãŒæ‚ªåŒ– | åˆ†å‰²å‰å¾Œã§worstæ¯”è¼ƒå¿…é ˆ |

### 8.2 ç«¶æŠ€å‘ã‘CVè¨­è¨ˆåŸå‰‡

1. **å¹³å‡ã‚’è¦‹ã‚‹ãªã€æœ€æ‚ªã‚’è¦‹ã‚**
2. **æ”¹å–„ã¯ worst-case ã§æ¸¬ã‚Œ**
3. **å®Ÿé¨“å‰å¾Œã§ worst-case ã‚’å¿…ãšæ¯”è¼ƒ**

---

## 9. è¿½åŠ æ¤œè¨é …ç›®

### 9.1 TTA (Test Time Augmentation)

```python
tta_transforms = [
    lambda x: x,                    # Original
    lambda x: torch.flip(x, [2]),   # Horizontal flip
    lambda x: torch.flip(x, [3]),   # Vertical flip
    lambda x: torch.rot90(x, 1, [2,3]),  # 90Â° rotation
]
```

**æœŸå¾…åŠ¹æœ**: SSIM +0.01ã€œ0.02

### 9.2 Ensembleæˆ¦ç•¥

| æˆ¦ç•¥ | æœŸå¾…åŠ¹æœ |
|------|----------|
| Fold Ensemble | +0.02ã€œ0.03 |
| Architecture Ensemble | +0.03ã€œ0.05 |

### 9.3 Category C å¼·åŒ–ç­–

| æˆ¦ç•¥ | æœŸå¾…åŠ¹æœ |
|------|----------|
| Cå‘ã‘Lossé‡ã¿å¢—åŠ  | +0.01ã€œ0.02 |
| Cå°‚ç”¨Fine-tuning | +0.02ã€œ0.03 |

---

## 10. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

- [x] Stratified K-Foldå®Ÿè£…
- [x] ã‚«ãƒ†ã‚´ãƒªåˆ¥è©•ä¾¡è¿½åŠ 
- [x] Worst-Case CV (ssim_C_worst20) è¿½åŠ 
- [x] C ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°å®Ÿé¨“ â†’ **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã€è¦å†æ¤œè¨**
- [ ] ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–ã—ã¦ baseline å†å–å¾—
- [ ] Multi-Seed CV æ¤œè¨¼
- [ ] Cå‘ã‘Lossé‡ã¿èª¿æ•´
- [ ] TTAå®Ÿè£…

---

*æœ€çµ‚æ›´æ–°: 2026-01-08 (exp_007 v3 çµæœåæ˜ )*
