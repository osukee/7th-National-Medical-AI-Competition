# 実験結果まとめ - Mask-Based Baseline

> 最終更新: 2026-01-11

## 実験履歴

| # | 日時 | 変更点 | SSIM(CV) | PSNR(CV) | PB Score | 所見 |
|---|------|--------|----------|----------|----------|------|
| 0 | 01/09 | 旧コード (フル画像Loss, ep3) | 0.87* | 15.3* | **0.354** | *フル画像評価 |
| 1 | 01/09 | マスクLoss導入, ep15 | 0.66 | 14.4 | **0.417** | +0.06 改善 |
| 2 | 01/10 | ep30 | 0.68 | 14.6 | **0.418** | 収束確認、頭打ち |
| 3 | 01/10 | MSE 0.02→0.1 | 0.66 | 14.5 | **0.417** | 効果なし |
| 4 | 01/10 | デバッグ追加 | 0.66 | 14.4 | - | 出力が0.07-0.10に潰れていた！ |
| 5 | 01/10 | sigmoid追加 (SimpleUNet) | 0.66 | 14.6 | - | 学習開始(12.5→14.6)、頭打ち |
| 6 | 01/11 | SMP U-Net (resnet34), ep3 | 0.39 | 15.1 | - | SMP動作確認 |
| 7 | 01/11 | SMP U-Net, ep15 (dr=1.0) | 0.915* | 20.5* | **0.409** | 🔴 CV-LB乖離 *評価ズレ |
| 8 | 01/11 | **LB-aligned評価 (dr=255, mask)** | **0.686** | **15.2** | **0.410** | ✅ CV適正化、LB+0.001 |
| 9 | 01/11 | **mask-outside weighting (0.2)** | - | - | - | 🧪 実験待ち |

---

## exp_008 詳細 (LB-aligned評価修正)

### 修正内容
1. `data_range=255` に変更 (以前は1.0)
2. mask-based SSIM/PSNR計算を追加
3. Dataset に mask読み込みを追加

### CV結果
```
PSNR: 15.23 dB
SSIM: 0.686 (±0.017)
  - A: 0.670
  - B: 0.710
  - C: 0.678
worst_eval: 0.925 (min: 0.847)
training_time: 3629s (~60min)
```

### 🎉 CV-LB乖離の改善
| 項目 | exp_007 (dr=1.0) | exp_008 (dr=255) |
|------|------------------|------------------|
| CV SSIM | 0.915 | **0.686** |
| CV PSNR | 20.5 dB | **15.2 dB** |
| PB Score | 0.409 | **0.410** |
| 乖離 | >0.5 | **0.28** |

→ **CV評価がLBに近づいた**

---

## 重大発見

### 1. SimpleUNetのsigmoid欠落 (実験4)
```
outputs: min=0.0748, max=0.0990  ← ほぼ灰色一色
```

### 2. CV-LB評価ズレ (実験7→8)
- `data_range=1.0` vs `data_range=255`
- mask無視 vs mask-based
→ CV=0.915でLB=0.409の原因

---

## 学んだ教訓

1. **評価指標の一致が最重要** - data_range, mask処理の完全一致
2. **デバッグ出力を最初から入れる** - value rangeの確認必須
3. **単一変数で実験** - 複数同時変更は原因特定不可
4. **kernel-metadata.json確認** - 実行スクリプトの確認
5. **CV-LB一致を最優先** - CVが高くてもLBが下がれば無意味
